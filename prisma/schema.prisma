generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Screen {
  id        String   @id @db.VarChar(64)
  createdAt DateTime @default(now())
  bmiData   BMI[]
}

model AdscapePlayer {
  id                  String   @id @default(uuid()) @db.Uuid
  screenId            String   @unique @db.VarChar(64)
  appVersion          String   @db.VarChar(10) // F1, F2, F3
  flowType            String?  @db.VarChar(10) // F1, F2, or null for normal player
  deviceName          String?  @db.VarChar(255)
  screenWidth         Int?
  screenHeight        Int?
  ipAddress           String?  @db.VarChar(45)
  location            String?  @db.VarChar(255)
  osVersion           String?  @db.VarChar(50)
  appVersionCode      String?  @db.VarChar(20)
  heightCalibration   Float?   @default(0) // Height calibration offset in cm (added/subtracted from sensor reading)
  paymentAmount       Float? // Payment amount in currency (e.g., 9.0 for â‚¹9)
  logoUrl             String?  @db.Text // Logo URL (self-hosted at ASSET_BASE_URL/assets/images/...)
  playlistId          String?  @db.VarChar(255) // Playlist ID assigned to this screen
  flowDrawerEnabled   Boolean? @default(true) // Enable/disable drawer shown when flow is active
  flowDrawerSlotCount Int?     @default(2) // Number of slots: 2, 3, or 5
  hideScreenId        Boolean? @default(false) // Hide screen ID display (when true, screen ID is hidden)
  smsEnabled          Boolean? @default(false) // Send SMS to user after payment completion
  smsLimitPerScreen   Int?     // Max SMS allowed for this screen (null = no limit)
  smsSentCount        Int?     @default(0) // Number of SMS sent for this screen (for limit enforcement)
  whatsappEnabled     Boolean? @default(false) // Send WhatsApp to user after payment completion
  whatsappLimitPerScreen Int?  // Max WhatsApp messages allowed for this screen (null = no limit)
  whatsappSentCount   Int?     @default(0) // Number of WhatsApp messages sent for this screen (for limit enforcement)
  flowDrawerSlots     Json? // Array of image URLs [url1, url2, ...] (self-hosted assets)
  flowDrawerImage1Url String?  @db.Text // Flow drawer image URL slot 1
  flowDrawerImage2Url String?  @db.Text // Flow drawer image URL slot 2
  flowDrawerImage3Url String?  @db.Text // Flow drawer image URL slot 3
  flowDrawerImage4Url String?  @db.Text // Flow drawer image URL slot 4
  flowDrawerImage5Url String?  @db.Text // Flow drawer image URL slot 5
  lastSeen            DateTime @default(now())
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  gender    String?  @db.VarChar(10) // 'Male' or 'Female'
  age       Int?     // Age in years
  mobile    String   @db.VarChar(20)
  createdAt DateTime @default(now())
  bmiData   BMI[]
}

model BMI {
  id            String   @id @db.Uuid
  screenId      String
  screen        Screen   @relation(fields: [screenId], references: [id], onDelete: Cascade)
  userId        String?  @db.Uuid
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  heightCm      Float
  weightKg      Float
  bmi           Float
  category      String
  timestamp     DateTime @default(now())
  deviceId      String?  @db.VarChar(255)
  appVersion    String?  @db.VarChar(10)
  location      String?  @db.VarChar(255)
  fortune       String?  @db.Text
  healthTip     String?  @db.Text // Locally-picked health tip from Android assets (by BMI category)
  paymentStatus Boolean? @default(false) // Whether payment was completed for this BMI record
  paymentAmount Float? // Actual amount paid by the user in rupees

  @@index([screenId])
  @@index([userId])
  @@index([userId, timestamp])
}

model AdminUser {
  id                 String                  @id @default(uuid()) @db.Uuid
  email              String                  @unique @db.VarChar(255)
  password           String                  @db.VarChar(255) // Hashed password
  name               String                  @db.VarChar(255)
  role               String                  @db.VarChar(20) // 'super_admin' or 'admin'
  totalMessageLimit  Int?                    // Total message (SMS) limit for this admin; set by super admin (admin role only)
  totalWhatsAppLimit Int?                    // Total WhatsApp message limit for this admin; set by super admin (admin role only)
  smsUsedCount       Int?                    @default(0) // Total SMS messages sent by this admin (across all assigned screens)
  whatsappUsedCount  Int?                    @default(0) // Total WhatsApp messages sent by this admin (across all assigned screens)
  isActive           Boolean                 @default(true)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  assignedScreens    AdminScreenAssignment[]

  @@index([email])
  @@index([role])
}

model AdminScreenAssignment {
  id           String    @id @default(uuid()) @db.Uuid
  adminId      String    @db.Uuid
  admin        AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  screenId        String    @db.VarChar(64)
  messageLimit    Int?      // Message (SMS) limit allocated to this screen by the admin (sum across screens <= admin totalMessageLimit)
  whatsappLimit   Int?      // WhatsApp message limit allocated to this screen by the admin (sum across screens <= admin totalWhatsAppLimit)
  smsEnabled      Boolean   @default(true)
  whatsappEnabled Boolean   @default(true)
  createdAt       DateTime  @default(now())

  @@unique([adminId, screenId])
  @@index([adminId])
  @@index([screenId])
}

// Note: These tables are managed via raw SQL but we define them here to prevent Prisma from dropping them
// screen_playlists table is created/updated via raw SQL in screenController.js
// playlists table is managed via raw SQL in playlistController.js
